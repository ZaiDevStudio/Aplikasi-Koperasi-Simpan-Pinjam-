<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pembayaran</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gold-theme">

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">Pembayaran</a>
            <div class="ms-auto"><a href="index.html" class="text-white"><i class="fas fa-home"></i></a></div>
        </div>
    </nav>

    <div class="container mt-5 pt-5">
        <div class="card p-4 shadow">
            <label class="form-label fw-bold">Cari Nasabah (yg punya hutang)</label>
            <select id="pilihNasabahBayar" class="form-select mb-3" onchange="loadTagihan()">
                <option value="">Pilih Nasabah...</option>
            </select>

            <div id="detailTagihan" style="display:none;">
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between">
                        <span>Cicilan per kali:</span>
                        <strong id="infoCicilan"></strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Sisa Angsuran:</span>
                        <strong id="infoSisaAngsuran"></strong>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Jumlah Bayar</label>
                    <input type="number" id="inputBayar" class="form-control fw-bold text-success">
                </div>

                <button onclick="prosesBayar()" class="btn btn-success w-100 btn-lg shadow">BAYAR SEKARANG</button>
            </div>
        </div>
    </div>

    <footer>@2025 Koperasi Simpan Pinjam. Developer Y. Zai, A.Md.Kom</footer>

    <script src="script.js"></script>
    <script>
        let selectedPinjaman = null;

        // Load nasabah yg punya hutang
        const data = getDB('pinjamanDB').filter(d => d.sisaSaldo > 0);
        const select = document.getElementById('pilihNasabahBayar');
        data.forEach(d => {
            let opt = document.createElement('option');
            opt.value = d.idPinjaman;
            opt.text = `${d.nama} - Sisa: ${formatRupiah(d.sisaSaldo)}`;
            select.appendChild(opt);
        });

        function loadTagihan() {
            const id = parseInt(select.value);
            selectedPinjaman = data.find(d => d.idPinjaman === id);
            
            if(selectedPinjaman) {
                document.getElementById('detailTagihan').style.display = 'block';
                document.getElementById('infoCicilan').innerText = formatRupiah(selectedPinjaman.nominalCicilan);
                document.getElementById('infoSisaAngsuran').innerText = selectedPinjaman.sisaAngsuran + " kali";
                document.getElementById('inputBayar').value = selectedPinjaman.nominalCicilan;
            } else {
                document.getElementById('detailTagihan').style.display = 'none';
            }
        }

        function prosesBayar() {
            if(!selectedPinjaman) return;
            
            const bayar = parseFloat(document.getElementById('inputBayar').value);
            if(bayar <= 0) return alert("Nominal salah");

            // Update logic
            let allData = getDB('pinjamanDB');
            let idx = allData.findIndex(x => x.idPinjaman === selectedPinjaman.idPinjaman);
            
            let now = new Date();
            let historyItem = {
                tgl: now.toLocaleDateString('id-ID'),
                jam: now.toLocaleTimeString('id-ID'),
                bayar: bayar,
                ke: (allData[idx].jmlAngsuran - allData[idx].sisaAngsuran) + 1
            };

            allData[idx].sisaSaldo -= bayar;
            allData[idx].sisaAngsuran -= 1;
            if(allData[idx].sisaSaldo < 0) allData[idx].sisaSaldo = 0;
            if(allData[idx].sisaAngsuran < 0) allData[idx].sisaAngsuran = 0;
            if(allData[idx].sisaSaldo === 0) allData[idx].status = "LUNAS";
            
            allData[idx].historyPembayaran.push(historyItem);

            setDB('pinjamanDB', allData);
            alert("Pembayaran Berhasil!");
            window.location.href = "bukti.html"; // Redirect ke bukti
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
